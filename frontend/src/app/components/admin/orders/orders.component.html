<div class="card shadow p-3">
    <!-- Header -->
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center mb-3 gap-3">
        <h4 class="mb-0">Qu·∫£n l√Ω ƒë∆°n h√†ng</h4>
        <div class="d-flex gap-2 w-100 w-lg-auto">
            <select class="form-select" style="min-width: 200px;" (change)="onStatusChange($event)">
                <option value="">-- L·ªçc theo tr·∫°ng th√°i --</option>
                <option *ngFor="let s of statusOptions" [value]="s">{{s}}</option>
            </select>
        </div>
    </div>

    <!-- Table -->
    <div class="table-responsive">
        <table class="table table-bordered table-hover">
            <thead class="thead-dark">
                <tr>
                    <th class="d-none d-md-table-cell">M√£</th>
                    <th>Kh√°ch h√†ng</th>
                    <th class="d-none d-lg-table-cell">Ng√†y ƒë·∫∑t</th>
                    <th class="d-none d-xl-table-cell">Thanh to√°n</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th class="text-end">T·ªïng ti·ªÅn</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody *ngIf="!loading; else loadingTpl">
                <tr *ngFor="let o of orders">
                    <td class="d-none d-md-table-cell">{{o.id}}</td>
                    <td>
                        <div class="d-flex flex-column">
                            <strong>{{ o.fullname || o.user.name }}</strong>
                            <small class="text-muted d-lg-none">
                                #{{o.id}} | {{ o.orderDate | date:'dd/MM/yyyy':'UTC' }}
                            </small>
                        </div>
                    </td>
                    <td class="d-none d-lg-table-cell">{{ o.orderDate | date:'dd/MM/yyyy HH:mm':'UTC' }}</td>
                    <td class="d-none d-xl-table-cell">{{ o.paymentMethod }}</td>
                    <td><span [class]="statusClass(o.status)">{{ o.status }}</span></td>
                    <td class="text-end">{{ o.totalMoney | number:'1.0-0' }} ƒë</td>
                    <td>
                        <div class="btn-group-vertical btn-group-sm d-flex d-md-inline-flex" role="group">
                            <button class="btn btn-primary btn-sm mb-1" (click)="openDetail(o)" title="Xem chi ti·∫øt">
                                <i class="fa fa-eye"></i>
                            </button>
                            <button class="btn btn-warning btn-sm" (click)="openEdit(o)" title="S·ª≠a">
                                <i class="fa fa-edit"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
            <ng-template #loadingTpl>
                <tbody>
                    <tr>
                        <td colspan="7" class="text-center">ƒêang t·∫£i...</td>
                    </tr>
                </tbody>
            </ng-template>
        </table>
    </div>
</div>

<!-- Pagination -->
<div class="d-flex flex-column flex-sm-row justify-content-between align-items-center mt-3 gap-2">
    <div class="text-center text-sm-start">
        <small class="text-muted">T·ªïng: {{ meta.total }} | Trang {{ meta.page }} / {{ meta.pages }}</small>
    </div>
    <div class="btn-group">
        <button class="btn btn-outline-secondary" (click)="prev()" [disabled]="meta.page<=1">¬´</button>
        <button class="btn btn-outline-secondary" (click)="next()" [disabled]="meta.page>=meta.pages">¬ª</button>
    </div>
</div>

<!-- Modal Chi ti·∫øt -->
<div #orderDetailModal class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content" *ngIf="selectedOrder as o">
            <div class="modal-header">
                <h5 class="modal-title">Chi ti·∫øt ƒë∆°n #{{ o.id }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">

                <!-- Th√¥ng tin kh√°ch h√†ng -->
                <h6 class="mb-2">üë§ Kh√°ch h√†ng</h6>
                <div class="row mb-3">
                    <div class="col-md-6"><strong>H·ªç t√™n:</strong> {{ o.fullname }}</div>
                    <div class="col-md-6"><strong>Email:</strong> {{ o.email }}</div>
                    <div class="col-md-6"><strong>SƒêT:</strong> {{ o.phoneNumber }}</div>
                    <div class="col-md-6"><strong>ƒê·ªãa ch·ªâ:</strong> {{ o.address }}</div>
                    <div class="col-12"><strong>Ghi ch√∫:</strong> {{ o.note || '‚Äî' }}</div>
                </div>

                <!-- Th√¥ng tin ƒë∆°n h√†ng -->
                <h6 class="mb-2">üì¶ ƒê∆°n h√†ng</h6>
                <div class="row mb-3">
                    <div class="col-md-4"><strong>Ng√†y ƒë·∫∑t:</strong> {{ o.orderDate | date:'dd/MM/yyyy HH:mm' }}</div>
                    <div class="col-md-4"><strong>Tr·∫°ng th√°i:</strong> <span [class]="statusClass(o.status)">{{ o.status
                            }}</span></div>
                    <div class="col-md-4"><strong>K√≠ch ho·∫°t:</strong> {{ o.active ? 'C√≥' : 'Kh√¥ng' }}</div>
                    <div class="col-md-4"><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> {{ o.paymentMethod }}</div>
                    <div class="col-md-4"><strong>Ph∆∞∆°ng th·ª©c giao h√†ng:</strong> {{ o.shippingMethod }}</div>
                    <div class="col-md-4"><strong>M√£ v·∫≠n ƒë∆°n:</strong> {{ o.trackingNumber || '‚Äî' }}</div>
                    <div class="col-md-6"><strong>ƒê·ªãa ch·ªâ giao:</strong> {{ o.shippingAddress }}</div>
                    <div class="col-md-6"><strong>Ng√†y giao d·ª± ki·∫øn:</strong> {{ o.shippingDate | date:'dd/MM/yyyy' }}
                    </div>
                </div>


                <!-- Chi ti·∫øt s·∫£n ph·∫©m -->
                <h6 class="mb-2">üõí S·∫£n ph·∫©m</h6>
                <table class="table table-bordered table-sm align-middle">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>T√™n</th>
                            <th>Danh m·ª•c</th>
                            <th>Size</th>
                            <th>M√†u</th>
                            <th class="text-end">Gi√°</th>
                            <th class="text-end">SL</th>
                            <th class="text-end">Th√†nh ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let d of o.orderDetails; let i = index">
                            <td>{{ i+1 }}</td>
                            <td>{{ d.productName }}</td>
                            <td>{{ d.categoryName }}</td>
                            <td>{{ d.size }}</td>
                            <td>{{ d.color }}</td>
                            <td class="text-end">{{ d.price | number:'1.0-0' }} ƒë</td>
                            <td class="text-end">{{ d.numberOfProducts }}</td>
                            <td class="text-end">{{ d.totalMoney | number:'1.0-0' }} ƒë</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="7" class="text-end fw-bold">T·ªïng c·ªông</td>
                            <td class="text-end fw-bold">{{ o.totalMoney | number:'1.0-0' }} ƒë</td>
                        </tr>
                    </tfoot>
                </table>

            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal S·ª≠a tr·∫°ng th√°i -->
<div #editStatusModal class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" *ngIf="selectedOrder as o">
            <div class="modal-header">
                <h5 class="modal-title">C·∫≠p nh·∫≠t tr·∫°ng th√°i #{{o.id}}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="form-label">Tr·∫°ng th√°i</label>
                <select class="form-select" [(ngModel)]="newStatus" [disabled]="saving">
                    <option *ngFor="let s of statusOptions" [value]="s">{{s}}</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" [disabled]="saving">H·ªßy</button>
                <button class="btn btn-primary" (click)="updateStatus()" [disabled]="saving">
                    {{ saving ? 'ƒêang l∆∞u...' : 'L∆∞u' }}
                </button>
            </div>
        </div>
    </div>
</div>